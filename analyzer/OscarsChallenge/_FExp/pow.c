#include "defs.h"
#include <stdio.h>

static const double log2e[] = {
 (double)(48408812.0 / 67108864.0L * 2),
 (double)(43368831.0 / 67108864.0L / 67108864.0L * 2),
 (double)(3076001.0 / 67108864.0L / 67108864.0L / 67108864.0L * 2),
 (double)(67031145.0 / 67108864.0L / 67108864.0L / 67108864.0L
  / 67108864.0L * 2),
 };



static const double scale = (double)(1 << 0);

static const double lnbias[][4] = {
 {
 -33554432.0 * 2 / 67108864.0L,
 -0.0 * 2 / (67108864.0L * 67108864.0L),
 -0.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -32064812.0 * 2 / 67108864.0L,
 -36291593.0 * 2 / (67108864.0L * 67108864.0L),
 -59567263.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -30619666.0 * 2 / 67108864.0L,
 -2733927.0 * 2 / (67108864.0L * 67108864.0L),
 -19949173.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -29216413.0 * 2 / 67108864.0L,
 -53631073.0 * 2 / (67108864.0L * 67108864.0L),
 -52065808.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -27852695.0 * 2 / 67108864.0L,
 -6308503.0 * 2 / (67108864.0L * 67108864.0L),
 -35133437.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -26526343.0 * 2 / 67108864.0L,
 -19181878.0 * 2 / (67108864.0L * 67108864.0L),
 -50595768.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -25235365.0 * 2 / 67108864.0L,
 -7330175.0 * 2 / (67108864.0L * 67108864.0L),
 -24581577.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -23977922.0 * 2 / 67108864.0L,
 -43925272.0 * 2 / (67108864.0L * 67108864.0L),
 -54451491.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -22752317.0 * 2 / 67108864.0L,
 -42359950.0 * 2 / (67108864.0L * 67108864.0L),
 -41999210.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -21556977.0 * 2 / 67108864.0L,
 -38559332.0 * 2 / (67108864.0L * 67108864.0L),
 -13908310.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -20390443.0 * 2 / 67108864.0L,
 -47979806.0 * 2 / (67108864.0L * 67108864.0L),
 -61187749.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -19251360.0 * 2 / 67108864.0L,
 -18411435.0 * 2 / (67108864.0L * 67108864.0L),
 -61732296.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -18138464.0 * 2 / 67108864.0L,
 -66691774.0 * 2 / (67108864.0L * 67108864.0L),
 -8446112.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -17050580.0 * 2 / 67108864.0L,
 -48668454.0 * 2 / (67108864.0L * 67108864.0L),
 -10023783.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -15986607.0 * 2 / 67108864.0L,
 -63598934.0 * 2 / (67108864.0L * 67108864.0L),
 -27753896.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -14945518.0 * 2 / 67108864.0L,
 -5934076.0 * 2 / (67108864.0L * 67108864.0L),
 -35408620.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -13926347.0 * 2 / 67108864.0L,
 -36708683.0 * 2 / (67108864.0L * 67108864.0L),
 -51121150.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -12928192.0 * 2 / 67108864.0L,
 -22542246.0 * 2 / (67108864.0L * 67108864.0L),
 -20133197.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -11950203.0 * 2 / 67108864.0L,
 -17611037.0 * 2 / (67108864.0L * 67108864.0L),
 -16889556.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -10991581.0 * 2 / 67108864.0L,
 -39442611.0 * 2 / (67108864.0L * 67108864.0L),
 -3961460.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -10051575.0 * 2 / 67108864.0L,
 -7216589.0 * 2 / (67108864.0L * 67108864.0L),
 -3330340.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -9129474.0 * 2 / 67108864.0L,
 -40664619.0 * 2 / (67108864.0L * 67108864.0L),
 -3742343.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -8224610.0 * 2 / 67108864.0L,
 -43017187.0 * 2 / (67108864.0L * 67108864.0L),
 -19145723.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -7336350.0 * 2 / 67108864.0L,
 -41942860.0 * 2 / (67108864.0L * 67108864.0L),
 -50445322.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -6464096.0 * 2 / 67108864.0L,
 -11271123.0 * 2 / (67108864.0L * 67108864.0L),
 -10066598.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -5607280.0 * 2 / 67108864.0L,
 -44038859.0 * 2 / (67108864.0L * 67108864.0L),
 -8593864.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -4765367.0 * 2 / 67108864.0L,
 -2798409.0 * 2 / (67108864.0L * 67108864.0L),
 -28619918.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -3937845.0 * 2 / 67108864.0L,
 -55023594.0 * 2 / (67108864.0L * 67108864.0L),
 -46962292.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -3124233.0 * 2 / 67108864.0L,
 -11959770.0 * 2 / (67108864.0L * 67108864.0L),
 -26011496.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -2324069.0 * 2 / 67108864.0L,
 -19923620.0 * 2 / (67108864.0L * 67108864.0L),
 -60922053.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -1536916.0 * 2 / 67108864.0L,
 -52913507.0 * 2 / (67108864.0L * 67108864.0L),
 -22404700.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -762359.0 * 2 / 67108864.0L,
 -17579626.0 * 2 / (67108864.0L * 67108864.0L),
 -45200036.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},

 {
 -0.0 * 2 / 67108864.0L,
 -0.0 * 2 / (67108864.0L * 67108864.0L),
 -0.0 * 2 / (67108864.0L * 67108864.0L) / 67108864.0L},
 };

double (_Pow)(double x, double y, short *pex)
 {
 double x1;
 double yi = y;
 double z;

 long zexp = 0;
 short xexp;
 short neg;

 if (y == 1.0)
  return (x);

 short errx = _Dunscale(&xexp, &x);
 const short erry = _Dint(&yi, 0);

 static const double invln2 = 1.4426950408889634073599246810018922;
 static const double ln2 = 0.69314718055994530941723212145817657;
 static const double rthalf = 0.70710678118654752440084436210484904;
 static const double maxexp = (double)(32768);

 printf("errx=%d,xexp=%d,x=%.17g, erry=%d, y=%.17g, yi=%.17g,\n",errx,xexp,x,erry,y,yi);





 if (pex != 0)
  *pex = 0;
 if ((erry == 0 && y == 0.0)
  || (errx < 0 && xexp == 1
   && (x == 0.5 || (erry == 1 && x == -0.5))))
  return (1.0);
 else if (0 <= errx || 0 < erry)
  {
  if (errx == 2)
   return (x);
  else if (erry == 2)
   return (y);
  else if (errx == 1)
   if (!((*_Pmsw(&(x))) & ((unsigned short)0x8000)))
    return (((*_Pmsw(&(y))) & ((unsigned short)0x8000)) ? 0.0 : _Inf._Double);
   else if (!((*_Pmsw(&(y))) & ((unsigned short)0x8000)))
    return (erry == 0 && _Dint(&yi, -1) < 0
     ? -_Inf._Double
     : _Inf._Double);
   else
    return (erry == 0 && _Dint(&yi, -1) < 0
     ? -_Zero : 0.0);
  else if (erry == 1)
   if (!((*_Pmsw(&(y))) & ((unsigned short)0x8000)))
    return (xexp <= 0 ? 0.0 : _Inf._Double);
   else
    return (xexp <= 0 ? _Inf._Double : 0.0);
  else
   if (!((*_Pmsw(&(y))) & ((unsigned short)0x8000)))
    return (erry == 0 && _Dint(&yi, -1) < 0 && ((*_Pmsw(&(x))) & ((unsigned short)0x8000))
     ? -_Zero : 0.0);
   else
    {
    _Feraise(0x02);
    return (erry == 0 && _Dint(&yi, -1) < 0 && ((*_Pmsw(&(x))) & ((unsigned short)0x8000))
     ? -_Inf._Double : _Inf._Double);
    }
  }
 else if (((*_Pmsw(&(x))) & ((unsigned short)0x8000)) && erry < 0)
  {
  _Feraise(0x01);
  return (_Nan._Double);
  }

 if (0.0 < x)
  neg = 0;
 else
  {
  ((*_Pmsw(&(x))) ^= ((unsigned short)0x8000));
  neg = _Dint(&yi, -1);
  }


  {
 double z, w;

 if (x < rthalf)
  {
  x *= 2.0;
  --xexp;
  }

 z = ((x - 1.0) / (x + 1.0));
 w = z * z;

 x -= 1.0;
 x1 = z * (w * _Logpoly(w) - x);

 yi = (double)xexp + (x + x1) * invln2;
 printf("z_local=%.17g, w=%.17g\n",z,w);
  }
 z = y * yi;
 printf("z=%.17g,y=%.17g, y1=%.17g, x=%.17g, x1=%.17g\n",z,y,yi,x,x1);

 if (z < -maxexp)
  errx = 0;
 else if (-15.0 <= z && z <= 15.0
  && -40.0 < y && y < 40.0)
  {
  zexp = (long)(z < 0.0 ? z - 0.5 : z + 0.5);
  z = y * (x + x1);


  z += (y * (double)xexp - (double)zexp) * ln2;






  errx = -1;
  }
 else if (maxexp < z)
  errx = 1;
 else
  {
  double xpx1[2], xpx[4], xpy[4], xpz[4];
  int i;

  _Xp_setw(xpx, 4, x);
  _Xp_setw(xpx1, 2, x1);
  _Xp_addx(xpx, 4, xpx1, 2);

  if (xpx[0] == 0.0)
   _Xp_setw(xpy, 4, 0.0);
  else
   {
   memcpy_HighTecARMImpl(xpy, log2e, sizeof (xpy));
   _Xp_mulh(xpy, 4, xpx[0]);
   for (i = 1; i < 4 && xpx[i] != 0.0; ++i)
    {
		printf("for i=%d,xpx[%d]=%.17g (xpx[%d]=%.17g, x was %.17g)\n",i,i,xpx[i],(i+1),xpx[i+1],x);
    double xpw[4];

    memcpy_HighTecARMImpl(xpw, log2e, sizeof (xpw));
    _Xp_mulh(xpw, 4, xpx[i]);
    _Xp_addx(xpy, 4, xpw, 4);
    }
   }
  _Xp_addh(xpy, 4, (double)xexp);

  _Xp_setw(xpx, 2, y);
  memcpy_HighTecARMImpl(xpz, xpy, sizeof (xpz));
  _Xp_mulh(xpz, 4, xpx[0]);

  if (xpx[1] != 0.0)
   {
   double xpw[4];

   memcpy_HighTecARMImpl(xpw, xpy, sizeof (xpw));
   _Xp_mulh(xpw, 4, xpx[1]);
   _Xp_addx(xpz, 4, xpw, 4);
   }

  x = xpz[0];
  printf("xpz[0]=%.17g, xpz[1]=%.17g (zexp=%d)\n",xpz[0], xpz[1],zexp);
  if (xpz[0] != 0.0 && xpz[1] != 0.0)
   x += xpz[1] + xpz[2];
  _Dint(&x, 0);
  _Xp_addh(xpz, 4, -x);
  z = _Xp_getw(xpz, 4);
  z *= ln2;
  zexp = (long)x;
  errx = -1;
  }

 if (errx < 0)
  {
  if (pex != 0)
   {
   *pex = zexp;
   zexp = 0;
   }
   printf("calling _Exp(&z,1,%d)",zexp);
  errx = _Exp(&z, 1.0, zexp);
  printf("=%d -> z=%.17g\n",errx,z);
   }
 switch (errx)
  {
 case 0:
  z = 0.0;
  _Feraise(0x08);
  break;

 case 1:
   printf("case 1: z=%.17g (neg:%d)\n",z,neg);
  if (z < 0.0)
   {
   z = 0.0;
   _Feraise(0x08);
   }
  else
   {
   z = _Inf._Double;
   _Feraise(0x04);
   }
  }

 if (neg)
  ((*_Pmsw(&(z))) ^= ((unsigned short)0x8000));
 return (z);
 }

double (pow)(double x, double y)
 {
	 printf("calling _Pow(x=%.17g,y=%.17g)\n",x,y);
 return (_Pow(x, y, 0));
 }

